<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Users</title>
  <link rel="stylesheet" href="./css/index.css" />
</head>

<body data-page="products">
  <div id="app">
    <div data-include="./partials/sidebar.html"></div>
    <div class="main">
      <div data-include="./partials/header.html"></div>
      <main class="content">
        <form id="frm_product" enctype="multipart/form-data">
          ID <input type="text" name="id" id="productId" readonly>
          Tên sản phẩm <input type="text" name="name" id="name">
          SKU <input type="text" name="sku" id="sku">
          Danh mục <select onchange="setGenerateSKU()" id="category" name="category">
            <option value="">-- Chọn danh mục --</option>
          </select>
          Giá sản phẩm <input type="text" name="price" id="price">
          Số lượng <input type="text" name="stock" id="stock">
          <input name="image" type="file" accept="image/*" id="imageInput">
          <img id="previewImg" style="max-width:200px;max-height:200px;display:none;border:1px solid #ddd">
          Mô tả <textarea id="description" name="description" rows="3" cols="30"></textarea>
          <button>Thêm</button>
          <button type="button" onclick="deleteProduct()">Xóa</button>
          <button type="button" onclick="updateProduct()">Sửa</button>
        </form>
        <table id="productTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tên SP</th>
              <th>SKU</th>
              <th>Danh mục</th>
              <th>Giá</th>
              <th>Số lượng</th>
              <th>Hình ảnh</th>
              <th>Mô tả</th>
            </tr>
          </thead>
          <tbody id="tbody">
          </tbody>
     
        </table>
      </main>
      <div data-include="./partials/footer.html"></div>
    </div>
  </div>

  <script src="./js/include.js"></script>
  <script src="./js/cellClick.js"></script>
  <script>
    document.addEventListener("includes:loaded", async () => {
      loadCategories()
      loadTableProduct()
      initCellClick('productTable');
      document.getElementById("frm_product").addEventListener("submit", function (e) {
        e.preventDefault();
        submitForm();
      });
      imageInput.addEventListener('change', function (e) {
        loadPreviewImage(e);
      });
      const tbody = document.querySelector("#productTable tbody");
      tbody.addEventListener("click", (e) => {
        const form = document.getElementById("frm_product");
        try {
          const row = e.target.closest("tr");
          if (!row) return;
          document.getElementById("productId").value = row.cells[0].innerText;
          document.getElementById("name").value = row.cells[1].innerText;
          document.getElementById("sku").value = row.cells[2].innerText;
          document.getElementById("price").value = row.cells[4].innerText;
          document.getElementById("stock").value = row.cells[5].innerText;
          document.getElementById("description").value = row.cells[7].innerText;
          const select = document.getElementById("category");
          for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].text === row.cells[3].innerText) {
              select.selectedIndex = i;
              break;
            }
          }
          const previewImg = document.getElementById("previewImg");
          previewImg.src = row.cells[6].innerText; // hoặc đường dẫn đúng
          previewImg.style.display = 'block';
        } catch (error) {
          alert(error)
        }
      });
      generateSku();
    });
    // ---------------------------------------------------------------------
    async function loadCategories() {
      try {
        const res = await fetch("http://localhost:3000/api/categories");
        const categories = await res.json();
        document.getElementById("category").innerHTML = `
      <option value="">-- Chọn danh mục --</option>
      ${categories.map(c => `<option value="${c.id}">${c.name}</option>`).join("")}
    `;
      } catch (err) {
        alert(err)
        document.querySelector("select[name='category']").innerHTML = `<option disabled>Lỗi tải danh mục</option>`;
      }
    }
    async function generateSku() {
      try {
        const select = document.getElementById("category");
        const categoryName = select.selectedOptions[0].text;
        const initials = categoryName
          .split(" ")
          .map(word => word.charAt(0).toUpperCase())
          .join("");
        const res = await fetch("http://localhost:3000/api/products");
        const products = await res.json();
        const existingSkus = products.map(p => p.sku);
        let newSku;
        do {
          const randomNumber = Math.floor(1000 + Math.random() * 9000);
          newSku = initials + randomNumber;
        } while (existingSkus.includes(newSku));
        console.log("SKU mới:", newSku);
        return newSku;
      } catch (err) {
        console.error(err);
      }
    }
    async function setGenerateSKU() {
      const sku = await generateSku();
      document.getElementById("sku").value = sku;
    }

    // Hàm helper để khởi tạo DataTable đơn giản
    function initDataTable(tableId) {
      if ($.fn.DataTable.isDataTable('#' + tableId)) {
        $('#' + tableId).DataTable().destroy();
      }
      $('#' + tableId).DataTable({
        pageLength: 10,
        searching: true,
        responsive: true
      });
    }

    async function loadTableProduct() {
      try {
        const res = await fetch("http://localhost:3000/api/products");
        const products = await res.json();
        document.getElementById("tbody").innerHTML = `
            ${products.map(p => `            <tr>
              <td>${p.id}</td>
              <td>${p.name}</td>
              <td>${p.sku}</td>
              <td>${p.category_id}</td>
              <td>${p.price}</td>
              <td>${p.stock}</td>
        <td>
        ${p.image ? `<img src="${p.image}"  width="150px">` : "Chưa có"}
        </td>

              <td>${p.description}</td>
            </tr>`).join("")}
         `;
         
         initDataTable('productTable');
      } catch (err) {
        alert(err)
      }
    }
    async function submitForm() {
      const form = document.getElementById("frm_product");
      const formData = new FormData(form);
      const res = await fetch('/api/products', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        alert((data.message || "Lỗi thêm sản phẩm"));
        return;
      }
      alert("✅ " + data.message);
      await loadTableProduct();
    }
    async function deleteProduct() {
      try {
        const id = document.getElementById("productId").value;
        const res = await fetch(`/api/products/${id}`, {
          method: 'DELETE',
        });
        alert((await res.json()).message);
        loadTableProduct();
      } catch (error) {
      await  alert(error)
      }
    }
    async function updateProduct() {
      const id = document.getElementById("productId").value;
      try {
        const form = document.getElementById("frm_product");
        const formData = new FormData(form);
        const res = await fetch(`/api/products/${id}`, {
          method: 'PUT',
          body: formData
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert((data.message || "Lỗi cập nhật sản phẩm"));
          return;
        }
        alert("✅ " + data.message);
      await  loadTableProduct();
      } catch (error) {
        alert(error)
      }

    }
    function loadPreviewImage(e) {
      const imageInput = document.getElementById("imageInput");
      const previewImg = document.getElementById("previewImg");
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewImg.style.display = 'none';
      }
    }
  </script>
</body>

</html>